<!DOCTYPE html>
<html>
<head>
    <title>GNSS Station Analysis</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
        }
        #map { 
            width: 100%; 
            height: 100vh; 
            background-color: #f0f0f0;
        }
        #control-container {
            margin: 10px;
            padding: 15px;
            background-color: white;
            border-radius: 8px;
            width: 300px;
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 500;
        }
        label {
            font-weight: bold;
            margin-bottom: 5px;
            display: block;
        }
        select, input[type="range"] {
            width: 100%;
            margin-bottom: 15px;
        }
        #slider-value {
            font-weight: bold;
            color: #2c3e50;
        }
        .chart-container {
            width: 600px;
            height: 150px;
            margin-bottom: 10px;
        }
        .popup-header {
            margin-top: 0;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
    </style>
</head>
<body>
    <div id="loading">Loading map and station data...</div>
    
    <div id="control-container">
        <label for="metricSelect">Select Metric:</label>
        <select id="metricSelect" class="form-control">
            <option value="F1">F1 Score</option>
            <option value="TFR">True Failure Rate</option>
            <option value="FFR">False Failure Rate</option>
            <option value="MFR">Missed Failure Rate</option>
            <option value="FRI">Failure Rate Index</option>
            <option value="Count">Event Count</option>
        </select>

        <label for="valueSlider">Threshold ≤ <span id="slider-value">1.00</span></label>
        <input type="range" min="0" max="1" value="1" step="0.01" id="valueSlider">
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>

    <script>
    console.log("Starting GNSS Map Visualization");
    
    const map = L.map('map').setView([46.5, 8.2], 7);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors'
    }).addTo(map);

    const markerGroup = L.layerGroup().addTo(map);
    let stationData = [];

    const slider = document.getElementById("valueSlider");
    const sliderValueDisplay = document.getElementById("slider-value");
    const metricSelect = document.getElementById("metricSelect");
    const loadingElement = document.getElementById("loading");

    // Load station data
    Papa.parse("full_df_scores.csv", {
        download: true,
        header: true,
        dynamicTyping: true,
        complete: function(results) {
            if (!results.data || results.data.length === 0) {
                showError("CSV file is empty or invalid");
                return;
            }
            
            console.log(`Loaded ${results.data.length} stations`);
            stationData = results.data;
            updateMarkers();
            loadingElement.style.display = "none";
        },
        error: function(error) {
            showError(`Failed to load station data: ${error.message}`);
            console.error("CSV loading error:", error);
        }
    });

    slider.addEventListener("input", () => {
        sliderValueDisplay.textContent = parseFloat(slider.value).toFixed(2);
        updateMarkers();
    });

    metricSelect.addEventListener("change", () => {
        const metric = metricSelect.value;
        
        if (metric === "Count") {
            slider.min = 0;
            slider.max = 5000;
            slider.step = 100;
            slider.value = 5000;
        } else if (metric === "FRI") {
            slider.min = 0;
            slider.max = 3;
            slider.step = 0.01;
            slider.value = 3;
        } else {
            slider.min = 0;
            slider.max = 1;
            slider.step = 0.01;
            slider.value = 1;
        }
        
        sliderValueDisplay.textContent = slider.value;
        updateMarkers();
    });

    function updateMarkers() {
        markerGroup.clearLayers();
        const threshold = parseFloat(slider.value);
        const metric = metricSelect.value;

        if (!stationData || stationData.length === 0) {
            console.warn("No station data available");
            return;
        }

        stationData.forEach(station => {
            const value = station[metric];
            if (value !== null && !isNaN(value) && value <= threshold) {
                const marker = L.circleMarker([station.lat, station.lon], {
                    radius: 8,
                    color: getColor(value),
                    fillColor: getColor(value),
                    fillOpacity: 0.8,
                    weight: 1
                });

                marker.on('click', () => {
                    console.log("Showing details for:", station.Station_Name);
                    showStationDetails(station);
                });

                markerGroup.addLayer(marker);
            }
        });
    }

    function getColor(value) {
        const max = parseFloat(slider.max);
        const normalized = Math.min(1, value / max);
        const r = Math.floor(255 * (1 - normalized));
        const g = Math.floor(255 * normalized);
        return `rgb(${r},${g},0)`;
    }

    function showStationDetails(station) {
        const stationName = station.Station_Name;
        console.log(`Loading details for station: ${stationName}`);
        
        Papa.parse(`station_plots/${stationName}.csv`, {
            download: true,
            header: true,
            dynamicTyping: true,
            complete: function(results) {
                if (!results.data || results.data.length === 0) {
                    showError(`No data found for station ${stationName}`);
                    return;
                }
                
                const data = results.data;
                const html = createPopupHTML(station, data);
                const popup = L.popup({ maxWidth: 650 })
                    .setLatLng([station.lat, station.lon])
                    .setContent(html)
                    .openOn(map);
                
                setTimeout(() => renderAllCharts(stationName, data), 50);
            },
            error: function(error) {
                showError(`Failed to load data for station ${stationName}`);
                console.error("Station data error:", error);
            }
        });
    }

    function createPopupHTML(station, data) {
        // Sample every 5th point for cleaner labels
        const sampleFactor = Math.max(1, Math.floor(data.length / 20));
        const sampledLabels = data
            .filter((_, i) => i % sampleFactor === 0)
            .map(row => row.Epoch_Time);
        
        return `
            <div style="width: 600px; padding: 10px;">
                <h3 class="popup-header">${station.Station_Name}</h3>
                <p>
                    <strong>Location:</strong> ${station.lat?.toFixed(4)}, ${station.lon?.toFixed(4)}<br>
                    <strong>F1:</strong> ${station.F1?.toFixed(2) || 'N/A'} | 
                    <strong>TFR:</strong> ${station.TFR?.toFixed(2) || 'N/A'} | 
                    <strong>Count:</strong> ${station.Count || 'N/A'}
                </p>
                
                <div class="chart-container">
                    <canvas id="precip-chart-${station.Station_Name}"></canvas>
                </div>
                
                <div class="chart-container">
                    <canvas id="truth-chart-${station.Station_Name}"></canvas>
                </div>
                
                <div class="chart-container">
                    <canvas id="lstm-chart-${station.Station_Name}"></canvas>
                </div>
                
                <div class="chart-container">
                    <canvas id="unet-chart-${station.Station_Name}"></canvas>
                </div>
                
                <div class="chart-container">
                    <canvas id="xgb-chart-${station.Station_Name}"></canvas>
                </div>
            </div>
        `;
    }

    function renderAllCharts(stationName, data) {
        // Sample data points for cleaner x-axis labels
        const sampleFactor = Math.max(1, Math.floor(data.length / 20));
        const sampledData = data.filter((_, i) => i % sampleFactor === 0);
        const labels = sampledData.map(row => row.Epoch_Time);
        
        // Precipitation Chart (Top)
        renderChart(
            `precip-chart-${stationName}`,
            "Precipitation",
            sampledData.map(row => row.Rolling_Sum),
            '#3498db',
            'Precipitation (mm)',
            false
        );
        
        // Ground Truth Chart
        renderChart(
            `truth-chart-${stationName}`,
            "Ground Truth",
            sampledData.map(row => row.true_label),
            '#2c3e50',
            'Ground Truth',
            true
        );
        
        // LSTM Chart
        renderChart(
            `lstm-chart-${stationName}`,
            "LSTM Predictions",
            sampledData.map(row => row.Predicted_lstm),
            '#e74c3c',
            'LSTM',
            true
        );
        
        // UNet Chart
        renderChart(
            `unet-chart-${stationName}`,
            "UNet Predictions",
            sampledData.map(row => row.Predicted_nn),
            '#27ae60',
            'UNet',
            true
        );
        
        // XGBoost Chart (Bottom)
        renderChart(
            `xgb-chart-${stationName}`,
            "XGBoost Predictions",
            sampledData.map(row => row.Predicted_Binary),
            '#f39c12',
            'XGBoost',
            true
        );
    }

    function renderChart(canvasId, label, data, color, yLabel, isBinary) {
        try {
            const ctx = document.getElementById(canvasId).getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map((_, i) => i), // Use indices for cleaner x-axis
                    datasets: [{
                        label: label,
                        data: data,
                        borderColor: color,
                        backgroundColor: color + '20',
                        borderWidth: 1,
                        pointRadius: 0,
                        fill: false,
                        tension: isBinary ? 0 : 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            display: true,
                            ticks: {
                                callback: function(val, index) {
                                    // Only show every 5th label
                                    return index % 5 === 0 ? this.getLabelForValue(val) : '';
                                }
                            }
                        },
                        y: {
                            display: true,
                            title: {
                                display: true,
                                text: yLabel
                            },
                            min: isBinary ? 0 : Math.min(...data) * 0.9,
                            max: isBinary ? 1.2 : Math.max(...data) * 1.1
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    }
                }
            });
        } catch (error) {
            console.error(`Error rendering ${canvasId}:`, error);
        }
    }

    function showError(message) {
        loadingElement.innerHTML = `
            <div style="color: red;">
                <strong>Error:</strong> ${message}<br>
                Check browser console (F12) for details.
            </div>
        `;
        console.error(message);
    }
    </script>
</body>
</html>
