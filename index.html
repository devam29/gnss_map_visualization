<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>GNSS Stations Leaflet Map with Plots</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<!-- Leaflet CSS -->
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
/>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- PapaParse -->
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
  #map {
    height: 100vh;
  }
  .chart-canvas {
    display: block;
    width: 100%;
  }
</style>
</head>
<body>
<div id="map"></div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
  const map = L.map('map').setView([20, 78], 5);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 18,
  }).addTo(map);

  // Load stations data from full_df_scores.csv
  Papa.parse('full_df_scores.csv', {
    download: true,
    header: true,
    dynamicTyping: true,
    complete: function(results) {
      const stations = results.data;

      stations.forEach(station => {
        // Make sure station has lat, lon and station name
        if (!station.lat || !station.lon || !station.Station_Name) return;

        const marker = L.marker([station.lat, station.lon])
          .addTo(map)
          .bindTooltip(station.Station_Name)
          .on('click', () => fetchStationPlot(station.Station_Name, station));
      });
    }
  });

  function fetchStationPlot(stationName, station) {
    // Parse station CSV file inside station_plots folder
    Papa.parse(`/station_plots/${stationName}.csv`, {
      download: true,
      header: true,
      dynamicTyping: true,
      complete: function(results) {
        const data = results.data;

        // Extract arrays for charts
        const labels = data.map(row => row.Epoch_Time);
        const precip = data.map(row => row.Rolling_Sum);
        const truth = data.map(row => row.true_label);
        const lstm = data.map(row => row.Predicted_lstm);
        const nn = data.map(row => row.Predicted_nn);
        const xgb = data.map(row => row.Predicted_Binary);

        // Create popup content with three canvas charts
        const popupContent = `
          <div style="width: 600px;">
            <strong>${stationName}</strong><br>
            F1: ${station.F1?.toFixed(2)} | TFR: ${station.TFR?.toFixed(2)} | FFR: ${station.FFR?.toFixed(2)}<br>
            Count: ${station.Count} | Height: ${station.height}<br><br>

            <canvas id="precip-${stationName}" class="chart-canvas" height="100"></canvas>
            <canvas id="truth-${stationName}" class="chart-canvas" height="80"></canvas>
            <canvas id="models-${stationName}" class="chart-canvas" height="100"></canvas>
          </div>
        `;

        // Find marker's lat/lon for popup
        const popup = L.popup({ maxWidth: 700 })
          .setLatLng([station.lat, station.lon])
          .setContent(popupContent)
          .openOn(map);

        // Delay to ensure canvas elements are added before creating charts
        setTimeout(() => {
          const ctxPrecip = document.getElementById(`precip-${stationName}`).getContext('2d');
          const ctxTruth = document.getElementById(`truth-${stationName}`).getContext('2d');
          const ctxModels = document.getElementById(`models-${stationName}`).getContext('2d');

          new Chart(ctxPrecip, {
            type: 'line',
            data: {
              labels: labels,
              datasets: [{
                label: 'Precipitation',
                data: precip,
                borderColor: '#1f77b4',
                fill: false,
                tension: 0.1
              }]
            },
            options: {
              scales: {
                y: {
                  beginAtZero: true,
                  title: { display: true, text: 'Precipitation (mm)' }
                }
              }
            }
          });

          new Chart(ctxTruth, {
            type: 'line',
            data: {
              labels: labels,
              datasets: [{
                label: 'Ground Truth',
                data: truth,
                borderColor: '#2e2e2e',
                fill: false,
                stepped: true
              }]
            },
            options: {
              scales: {
                y: {
                  min: 0,
                  max: 1.2,
                  title: { display: true, text: 'True Label' }
                }
              }
            }
          });

          new Chart(ctxModels, {
            type: 'line',
            data: {
              labels: labels,
              datasets: [
                {
                  label: 'LSTM',
                  data: lstm,
                  borderColor: '#9467bd',
                  fill: false,
                  stepped: true
                },
                {
                  label: 'NN',
                  data: nn,
                  borderColor: '#2ca02c',
                  fill: false,
                  stepped: true
                },
                {
                  label: 'XGB',
                  data: xgb,
                  borderColor: '#d62728',
                  fill: false,
                  stepped: true
                }
              ]
            },
            options: {
              scales: {
                y: {
                  min: 0,
                  max: 1.2,
                  title: { display: true, text: 'Predicted Labels' }
                }
              }
            }
          });
        }, 100);
      },
      error: function(err) {
        alert(`Error loading data for station ${stationName}: ${err.message}`);
      }
    });
  }
</script>
</body>
</html>
