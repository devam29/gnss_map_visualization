<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>GNSS Station Plot</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- PapaParse for CSV -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    #map {
      height: 100vh;
    }

    #overlay {
      display: none;
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      width: 750px;
      height: 90vh;
      overflow: auto;
      background: white;
      border: 2px solid #333;
      border-radius: 10px;
      padding: 20px;
      z-index: 9999;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.4);
    }

    #overlay button {
      float: right;
      margin-bottom: 10px;
    }
  </style>
</head>
<body>

<div id="map"></div>

<!-- Floating overlay panel -->
<div id="overlay">
  <button onclick="document.getElementById('overlay').style.display='none'">Close âœ–</button>
  <div id="overlay-content"></div>
</div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
  const map = L.map('map').setView([20.0, 78.0], 5);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 18
  }).addTo(map);

  // Sample station data (replace with your real station coordinates and name)
  const sampleStation = {
    name: "0ABI",
    lat: 68.354344529,
    lon: 18.816445476000013,
    F1: 0.82,
    TFR: 0.76,
    FFR: 0.15,
    Count: 2300,
    height: 431.388473
  };

  const marker = L.marker([sampleStation.lat, sampleStation.lon])
    .addTo(map)
    .bindTooltip(sampleStation.name)
    .on('click', () => fetchStationPlot(sampleStation.name, sampleStation));

  function fetchStationPlot(stationName, station) {
    Papa.parse(`station_plots/${stationName}.csv`, {
      download: true,
      header: true,
      dynamicTyping: true,
      complete: function(results) {
        const data = results.data;
        const labels = data.map(row => row.Epoch_Time);
        const precip = data.map(row => row.Rolling_Sum);
        const truth = data.map(row => row.true_label);
        const lstm = data.map(row => row.Predicted_lstm);
        const nn = data.map(row => row.Predicted_nn);
        const xgb = data.map(row => row.Predicted_Binary);

        const html = `
          <h3 style="margin-bottom: 5px;">Station: ${stationName}</h3>
          <p>
            F1: ${station.F1?.toFixed(2)} | TFR: ${station.TFR?.toFixed(2)} | FFR: ${station.FFR?.toFixed(2)}<br>
            Count: ${station.Count} | Height: ${station.height}
          </p>
          <canvas id="precip-${stationName}" height="100"></canvas>
          <canvas id="truth-${stationName}" height="80"></canvas>
          <canvas id="models-${stationName}" height="100"></canvas>
        `;

        const overlay = document.getElementById('overlay');
        const overlayContent = document.getElementById('overlay-content');
        overlayContent.innerHTML = html;
        overlay.style.display = 'block';

        setTimeout(() => {
          const ctxPrecip = document.getElementById(`precip-${stationName}`).getContext('2d');
          const ctxTruth = document.getElementById(`truth-${stationName}`).getContext('2d');
          const ctxModels = document.getElementById(`models-${stationName}`).getContext('2d');

          new Chart(ctxPrecip, {
            type: 'line',
            data: {
              labels: labels,
              datasets: [{
                label: 'Precipitation',
                data: precip,
                borderColor: '#1f77b4',
                fill: false,
                tension: 0.1
              }]
            },
            options: {
              responsive: true,
              scales: {
                y: {
                  beginAtZero: true,
                  title: { display: true, text: 'Precipitation (mm)' }
                }
              }
            }
          });

          new Chart(ctxTruth, {
            type: 'line',
            data: {
              labels: labels,
              datasets: [{
                label: 'Ground Truth',
                data: truth,
                borderColor: '#2e2e2e',
                fill: false,
                stepped: true
              }]
            },
            options: {
              responsive: true,
              scales: {
                y: {
                  min: 0,
                  max: 1.2,
                  title: { display: true, text: 'True Label' }
                }
              }
            }
          });

          new Chart(ctxModels, {
            type: 'line',
            data: {
              labels: labels,
              datasets: [
                {
                  label: 'LSTM',
                  data: lstm,
                  borderColor: '#9467bd',
                  fill: false,
                  stepped: true
                },
                {
                  label: 'NN',
                  data: nn,
                  borderColor: '#2ca02c',
                  fill: false,
                  stepped: true
                },
                {
                  label: 'XGB',
                  data: xgb,
                  borderColor: '#d62728',
                  fill: false,
                  stepped: true
                }
              ]
            },
            options: {
              responsive: true,
              scales: {
                y: {
                  min: 0,
                  max: 1.2,
                  title: { display: true, text: 'Predicted Labels' }
                }
              }
            }
          });
        }, 100);
      }
    });
  }
</script>

</body>
</html>
