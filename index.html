<!DOCTYPE html>
<html>
<head>
    <title>Interactive GNSS Station Map</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        #map { width: 100%; height: 90vh; }
        #control-container {
            margin: 10px;
            padding: 10px;
            background-color: white;
            border-radius: 8px;
            width: 320px;
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 1000;
        }
        #slider-value { font-weight: bold; }
    </style>
</head>
<body>

<div id="control-container">
    <label for="metricSelect">Select Feature:</label><br>
    <select id="metricSelect">
        <option value="F1">F1 Score</option>
        <option value="TFR">TFR</option>
        <option value="FFR">FFR</option>
        <option value="MFR">MFR</option>
        <option value="FRI">FRI</option>
        <option value="Count">Count</option>
    </select><br><br>

    <label for="valueSlider">Threshold ≤ <span id="slider-value">1.00</span></label><br>
    <input type="range" min="0" max="1" value="1" step="0.01" id="valueSlider">
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>

<script>
    const map = L.map('map').setView([46.5, 2.5], 5);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors'
    }).addTo(map);

    const markerGroup = L.layerGroup().addTo(map);
    let stationData = [];

    const slider = document.getElementById("valueSlider");
    const sliderValueDisplay = document.getElementById("slider-value");
    const metricSelect = document.getElementById("metricSelect");

    Papa.parse("full_df_scores.csv", {
        download: true,
        header: true,
        dynamicTyping: true,
        complete: function(results) {
            stationData = results.data;
            updateMarkers();
        }
    });

    // Update map on slider or metric change
    slider.addEventListener("input", () => {
        sliderValueDisplay.textContent = parseFloat(slider.value).toFixed(2);
        updateMarkers();
    });

    metricSelect.addEventListener("change", () => {
        const metric = metricSelect.value;
        // Adjust slider range dynamically if needed
        if (metric === "Count") {
            slider.min = 0;
            slider.max = 5000;
            slider.step = 100;
            slider.value = 5000;
        } else if (metric === "FRI") {
            slider.min = 0;
            slider.max = 3;
            slider.step = 0.01;
            slider.value = 3;
        } else {
            slider.min = 0;
            slider.max = 1;
            slider.step = 0.01;
            slider.value = 1;
        }
        sliderValueDisplay.textContent = slider.value;
        updateMarkers();
    });

    function updateMarkers() {
        markerGroup.clearLayers();
        const threshold = parseFloat(slider.value);
        const metric = metricSelect.value;

        stationData.forEach(station => {
            const value = station[metric];
            if (value !== null && value <= threshold) {
                const marker = L.circleMarker([station.lat, station.lon], {
                    radius: 6,
                    color: getColor(value),
                    fillColor: getColor(value),
                    fillOpacity: 0.8,
                    weight: 1
                });

                const popup = `
                    <strong>${station.Station_Name}</strong><br>
                    F1: ${station.F1?.toFixed(2)}<br>
                    TFR: ${station.TFR?.toFixed(2)}<br>
                    FFR: ${station.FFR?.toFixed(2)}<br>
                    MFR: ${station.MFR?.toFixed(2)}<br>
                    FRI: ${station.FRI?.toFixed(2)}<br>
                    Count: ${station.Count}<br>
                    Height: ${station.height}
                `;

                marker.bindPopup(popup);
                marker.addTo(markerGroup);
            }
        });
    }

    function getColor(value) {
        const max = parseFloat(slider.max);
        const normalized = Math.min(1, value / max);
        const r = Math.floor(255 * (1 - normalized));
        const g = Math.floor(255 * normalized);
        return `rgb(${r},${g},0)`;
    }
</script>
</body>
</html>
