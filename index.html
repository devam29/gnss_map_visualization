<!DOCTYPE html>
<html>
<head>
    <title>Interactive GNSS Station Map</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        #map { width: 100%; height: 90vh; }
        #control-container {
            margin: 10px;
            padding: 10px;
            background-color: white;
            border-radius: 8px;
            width: 320px;
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 1000;
        }
        #slider-value { font-weight: bold; }

        /* Graph overlay styling */
        #graph-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background-color: rgba(255, 255, 255, 0.97);
            z-index: 2000;
            overflow-y: scroll;
            padding: 20px;
        }
        .close-btn {
            font-size: 24px;
            font-weight: bold;
            color: #444;
            float: right;
            cursor: pointer;
        }
        .plot-section {
            margin-bottom: 30px;
        }
        canvas {
            width: 100% !important;
            max-height: 200px;
        }
    </style>
</head>
<body>

<div id="control-container">
    <label for="metricSelect">Select Feature:</label><br>
    <select id="metricSelect">
        <option value="F1">F1 Score</option>
        <option value="TFR">TFR</option>
        <option value="FFR">FFR</option>
        <option value="MFR">MFR</option>
        <option value="FRI">FRI</option>
        <option value="Count">Count</option>
    </select><br><br>

    <label for="valueSlider">Threshold ≤ <span id="slider-value">1.00</span></label><br>
    <input type="range" min="0" max="1" value="1" step="0.01" id="valueSlider">
</div>

<div id="map"></div>

<!-- Overlay for graphs -->
<div id="graph-overlay">
    <span class="close-btn" onclick="closeOverlay()">×</span>
    <div id="station-details"></div>
    <div id="plot-container"></div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
const map = L.map('map').setView([46.5, 2.5], 5);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '© OpenStreetMap contributors'
}).addTo(map);

const markerGroup = L.layerGroup().addTo(map);
let stationData = [];

const slider = document.getElementById("valueSlider");
const sliderValueDisplay = document.getElementById("slider-value");
const metricSelect = document.getElementById("metricSelect");

Papa.parse("full_df_scores.csv", {
    download: true,
    header: true,
    dynamicTyping: true,
    complete: function(results) {
        stationData = results.data;
        updateMarkers();
    }
});

slider.addEventListener("input", () => {
    sliderValueDisplay.textContent = parseFloat(slider.value).toFixed(2);
    updateMarkers();
});

metricSelect.addEventListener("change", () => {
    const metric = metricSelect.value;
    if (metric === "Count") {
        slider.min = 0;
        slider.max = 5000;
        slider.step = 100;
        slider.value = 5000;
    } else if (metric === "FRI") {
        slider.min = 0;
        slider.max = 3;
        slider.step = 0.01;
        slider.value = 3;
    } else {
        slider.min = 0;
        slider.max = 1;
        slider.step = 0.01;
        slider.value = 1;
    }
    sliderValueDisplay.textContent = slider.value;
    updateMarkers();
});

function updateMarkers() {
    markerGroup.clearLayers();
    const threshold = parseFloat(slider.value);
    const metric = metricSelect.value;

    stationData.forEach(station => {
        const value = station[metric];
        if (value !== null && value <= threshold) {
            const marker = L.circleMarker([station.lat, station.lon], {
                radius: 6,
                color: getColor(value),
                fillColor: getColor(value),
                fillOpacity: 0.8,
                weight: 1
            });

            marker.on('click', () => {
                fetchStationPlot(station.Station_Name, station);
            });

            markerGroup.addLayer(marker);
        }
    });
}

function getColor(value) {
    const max = parseFloat(slider.max);
    const normalized = Math.min(1, value / max);
    const r = Math.floor(255 * (1 - normalized));
    const g = Math.floor(255 * normalized);
    return `rgb(${r},${g},0)`;
}

function closeOverlay() {
    document.getElementById("graph-overlay").style.display = "none";
    document.getElementById("plot-container").innerHTML = "";
}

function fetchStationPlot(stationName, station) {
    Papa.parse(`station_plots/${stationName}.csv`, {
        download: true,
        header: true,
        dynamicTyping: true,
        complete: function(results) {
            const data = results.data;
            const labels = data.map(row => row.Epoch_Time);
            const precip = data.map(row => row.Rolling_Sum);
            const truth = data.map(row => row.true_label);
            const lstm = data.map(row => row.Predicted_lstm);
            const nn = data.map(row => row.Predicted_nn);
            const xgb = data.map(row => row.Predicted_Binary);

            const overlay = document.getElementById("graph-overlay");
            document.getElementById("station-details").innerHTML = `
                <h2>${stationName}</h2>
                <p>F1: ${station.F1?.toFixed(2)} | TFR: ${station.TFR?.toFixed(2)} | FFR: ${station.FFR?.toFixed(2)}<br>
                MFR: ${station.MFR?.toFixed(2)} | FRI: ${station.FRI?.toFixed(2)} | Count: ${station.Count} | Height: ${station.height}</p>
            `;

            const plotContainer = document.getElementById("plot-container");
            plotContainer.innerHTML = "";  // Clear any previous content

            const datasets = [
                { label: 'Precipitation', data: precip, color: '#1f77b4', yMax: undefined, stepped: false },
                { label: 'Ground Truth', data: truth, color: '#2e2e2e', yMax: 1.2, stepped: true },
                { label: 'LSTM', data: lstm, color: '#9467bd', yMax: 1.2, stepped: true },
                { label: 'NN', data: nn, color: '#2ca02c', yMax: 1.2, stepped: true },
                { label: 'XGB', data: xgb, color: '#d62728', yMax: 1.2, stepped: true }
            ];

            datasets.forEach((ds, index) => {
                const canvasId = `plot-${stationName}-${index}`;
                const section = document.createElement("div");
                section.classList.add("plot-section");
                section.innerHTML = `<canvas id="${canvasId}"></canvas>`;
                plotContainer.appendChild(section);

                setTimeout(() => {
                    const ctx = document.getElementById(canvasId).getContext("2d");
                    new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: ds.label,
                                data: ds.data,
                                borderColor: ds.color,
                                stepped: ds.stepped,
                                fill: false
                            }]
                        },
                        options: {
                            responsive: true,
                            scales: {
                                y: {
                                    min: 0,
                                    max: ds.yMax,
                                    title: { display: true, text: ds.label.includes('Precip') ? 'mm' : 'Label' }
                                },
                                x: {
                                    ticks: {
                                        maxTicksLimit: 6,
                                        callback: function(value, index, ticks) {
                                            const label = this.getLabelForValue(value);
                                            return label.length > 10 ? label.substring(5, 10) : label;
                                        }
                                    }
                                }
                            },
                            plugins: {
                                legend: { display: false }
                            }
                        }
                    });
                }, 50);
            });

            overlay.style.display = "block";
        }
    });
}
</script>
</body>
</html>
